<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC
	"-//ibatis.apache.org//DTD Mapper 3.0//EN" 
	"http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">

<mapper namespace="dswork.common.dao.DsBaseUserBindDao">

<resultMap id="resultUserBind" type="dswork.common.model.IUserBind">
	<id property="id" column="ID" />
	<result property="bindid" column="BINDID" />
	<result property="userid" column="USERID" />
	<result property="openid" column="OPENID" />
	<result property="unionid" column="UNIONID" />
	<result property="name" column="NAME" />
	<result property="sex" column="SEX" />
	<result property="country" column="COUNTRY" />
	<result property="province" column="PROVINCE" />
	<result property="city" column="CITY" />
	<result property="avatar" column="AVATAR" />
	<result property="createtime" column="CREATETIME" />
	<result property="lasttime" column="LASTTIME" />
</resultMap>

<sql id="columnsUserBind">
	ID, BINDID, USERID, OPENID, UNIONID, NAME, SEX, COUNTRY, PROVINCE, CITY, AVATAR, CREATETIME, LASTTIME 
</sql>
<insert id="insertUserBind" parameterType="dswork.common.model.IUserBind">
	insert into DS_BASE_USER_BIND
	(<include refid="columnsUserBind" />)
	values
	(#{id},#{bindid},#{userid},#{openid},#{unionid},#{name},#{sex},#{country},#{province},#{city},#{avatar},#{createtime},#{lasttime})
</insert>
<update id="updateUserBind" parameterType="dswork.common.model.IUserBind">
	update DS_BASE_USER_BIND set
		BINDID=#{bindid},
		USERID=#{userid},
		OPENID=#{openid},
		UNIONID=#{unionid},
		NAME=#{name},
		SEX=#{sex},
		COUNTRY=#{country},
		PROVINCE=#{province},
		CITY=#{city},
		AVATAR=#{avatar},
		LASTTIME=#{lasttime}
	where ID=#{id}
</update>

<update id="updateUserBindForUnBind">
	update DS_BASE_USER_BIND set USERID=0 where USERID=#{userid} and BINDID in (${bindids})
</update>

<sql id="dynamicWhere">
	<where>
		<if test="@Ognl@isNotEmpty(id)"> and ID=#{id} </if>
		<if test="@Ognl@isNotEmpty(openid)"> and OPENID=#{openid} </if>
		<if test="@Ognl@isNotEmpty(unionid)"> and UNIONID=#{unionid} </if>
		<if test="@Ognl@isNotEmpty(bindid)"> and BINDID=#{bindid} </if>
	</where>
</sql>

<select id="queryUserBind" resultMap="resultUserBind">
	select <include refid="columnsUserBind" /> from DS_BASE_USER_BIND
	<include refid="dynamicWhere" />
</select>

<resultMap id="resultUserBindState" type="dswork.common.model.IUserBindState">
	<id property="id" column="ID" />
	<result property="status" column="STATUS" />
	<result property="name" column="NAME" />
	<result property="appid" column="APPID" />
	<result property="appreturnurl" column="APPRETURNURL" />
	<result property="apptype" column="APPTYPE" />
	<result property="memo" column="MEMO" />
	<result property="userbindid" column="USERBINDID" />
	<result property="userid" column="USERID" />
</resultMap>
<sql id="columnsBind"></sql>

<select id="getUserBindStateByUserId" resultMap="resultUserBindState">
	select b.ID, b.STATUS, b.NAME, b.APPID, b.APPRETURNURL, b.APPTYPE, b.MEMO, ub.ID as USERBINDID, ub.USERID from DS_BASE_BIND b
	left join DS_BASE_USER_BIND ub on ub.BINDID = b.ID and ub.USERID=#{userid}
	where b.STATUS=1
	group by b.ID
</select>

</mapper>
